!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.MR={})}(this,function(t){"use strict";var n=window;function e(){}function o(t,o){!function(t,o){var i,r=function(t){(t||4===i.readyState)&&(t=t||200!==i.status&&201!==i.status,r=e,i.onreadystatechange=null,o(!!t,i))};try{i=new n.XMLHttpRequest}catch(t){try{i=new n.ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{i=new n.ActiveXObject("Microsoft.XMLHTTP")}catch(t){(i={readyState:4,status:-1}).open=i.send=e}}}i.onerror=function(t){i.onerror=null,r(t)};try{i.open("GET",t,!0),i.send(null),i.onreadystatechange=function(){r()}}catch(t){r(t)}}(t,function(t,n){if(t)o(t,null);else try{o(t,JSON.parse(n.responseText))}catch(t){o(t,null)}})}var i="https://stat.radar.imgsmail.ru/update?v=1&p=oauth2";function r(t){(new Image).src=i+"&t=jssdk&i="+t+":1"}var a="__mr_oauth2__";function l(t,n,e){try{var o=window.localStorage,i=a+"."+t,r="ttl_"+a+"."+t;if(1===arguments.length){var l=parseInt(o.getItem(r),10);if(!l||l>Date.now())return JSON.parse(o.getItem(i))}else e>=0&&o.setItem(r,""+(Date.now()+1e3*e)),o.setItem(i,JSON.stringify(n))}catch(t){}return null}function s(t){return document.createElement(t)}function u(t,n){t.appendChild(n)}function c(t){try{t.parentNode.removeChild(t)}catch(t){}}function d(t,n){if(t)for(var e in n)n.hasOwnProperty(e)&&(t.style[e]=n[e])}var f=function(t,n){void 0===n&&(n="1.5s");for(var e="_"+Date.now(),o=e+"-spin",i="",r=-146,a=0;r<=92;r+=2)i+='<use fill="rgb('+(a+=2)+","+a+","+a+')" xlink:href="#a" transform="rotate('+r+' 32 32)"/>';return("\n\t<style>\n\t."+e+" {\n\t\twidth: 64px;\n\t\theight: 64px;\n\t\tdisplay: inline-block;\n\t\t-webkit-animation: "+o+" "+n+" linear infinite;\n\t\t-moz-animation: "+o+" "+n+" linear infinite;\n\t\tanimation: "+o+" "+n+" linear infinite;\n\t}\n\t@-moz-keyframes "+o+" { 100% { -moz-transform: rotate(360deg); } }\n\t@-webkit-keyframes "+o+" { 100% { -webkit-transform: rotate(360deg); } }\n\t@keyframes "+o+' { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }\n\t</style>\n\t<div class="'+e+'"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 64 64">\n\t\t<defs>\n\t\t\t<path id="a" d="M0 0h32v32H0z"></path>\n\t\t\t<mask id="progress">\n\t\t\t\t<path d="M0 0h64v64H0z"></path>\n\t\t\t\t'+i+'\n\t\t\t</mask>\n\t\t</defs>\n\t\t<path fill="'+t+'" d="M54.6 47.6c-1.98-1.98-5.09-1.98-7.07 0-8.56 8.56-22.6 8.56-31.1 0-8.56-8.56-8.56-22.6 0-31.1 4.54-5.58-3.25-10.7-7.07-7.07-12.4 12.4-12.4 32.8 0 45.3 12.4 12.4 32.8 12.4 45.3 0 1.98-1.98 1.98-5.09 0-7.07zM32 54c-12.1 0-22-9.9-22-22s9.9-22 22-22c2.8 0 5-2.2 5-5s-2.2-5-5-5C14.4 0 0 14.4 0 32s14.4 32 32 32c7.16-.736 5.26-9.84 0-10z" mask="url(#progress)">\n\t\t</path>\n\t</svg></div>\n').trim()},p="unknown",g="connected",h="not_authorized",m="default",_="onetap",v="hidden",b="embedded",y="ru-RU",w="userinfo",x="mail.phone",E="full-fit",O="mailru-login-button",k="login",I="https://o2.mail.ru",S="2147483647",L="2147483646",M="__mailru_oauth_"+Date.now()+"_"+Math.random()+"__",N=location.protocol+"//"+location.host,T={ui:1,type:1,lang:1,auth:!1},U=/^data-/,C=/^on(load|error|(?:before)?click|login|logout)$/,A=/^https?:/,P=/[?&]lang=([^a-z_-]+)/i,D={},H=[],R=[],z=[],j="o2_mail_ru_popup_login",B=490,F=500,G=490,J=20,W="close_state",X="login_state",Y=1,q=!1,K={clientId:null},V=window,Z=V.document,$={btn:"jsapi/button",login:"login",logout:"jsapi/logout",userinfo:"userinfo"},Q=[],tt=!1,nt=!1,et=!1,ot=null,it=null,rt=null,at=null,lt=p,st=null,ut=null,ct=[];function dt(t,n){return t+":"+n}function ft(t,n,e,o){var i=dt(t,n);if(D.hasOwnProperty(i)||(D[i]=[]),o){var r=function(){!function(t,n,e){var o=dt(t,n);if(D.hasOwnProperty(o)){var i=D[o].indexOf(e);i>-1&&D[o].splice(i,1)}}(t,n,r),e.apply(null,arguments)};D[i].push(r)}else D[i].push(e)}function pt(t,n){var e=$[t]+"?client_id="+K.clientId+"&redirect_uri="+N+(n.lang?"":"&lang="+K.lang);return K.recaptcha,A.test(e)||(e=I+"/"+e),e+"&"+function(t){var n="";for(var e in t)t.hasOwnProperty(e)&&"function"!=typeof e&&null!=t[e]&&(n+="&"+encodeURIComponent(e)+"="+encodeURIComponent(t[e]));return n.substr(1)}(n)}function gt(t){It("call logout"),lt=lt===g?h:p,st=null,ut=null,it=null,ct.forEach(function(t){t.send("auth",lt)});var n=vt(!0);bt(t,n),bt(K.onlogin,n),bt(K.onlogout,n),l(X,null)}function ht(){var t,n;It("globalOnLogin invoked"),t=vt(),n=t.user,It("refresh all prorts",t),ct.forEach(function(e){e.send("auth",t.status),n&&e.send("auth:user",n)}),bt(K.onlogin,vt())}function mt(t,n){function e(t){function e(){ht(),ot.close(),bt(R,vt()),et=!1,it=null,R.length=0}It("login resolved",{ok:t,options:n}),t&&!1!==n.userinfo?_t(e):e()}if(void 0===n&&(n={}),null==n.mode&&(n.mode=m),It("call login",{options:n,authUser:!!st}),st)bt(t,vt());else{if(t&&R.push(t),et)return;if(rt){try{rt.close()}catch(t){}rt=null,V.clearInterval(at)}ot=function(t){var n=Y++,e=(a=t,l=a.mode,l===_&&!tt||l===b&&!nt),o=yt(e,n,t),i="popup_"+(e?"embedded_":"")+t.mode+"_";var a,l;if(It("openPortal",{id:n,embedded:e,options:t}),e){var p={id:n,loginUrl:o,options:t,radarPrefix:i};return function(t){var n=t.id,e=t.loginUrl,o=t.radarPrefix,i=t.options;It("open embedded portal:",n,e,o,i);var a=s("div"),l=s("div"),p=s("iframe"),g=Et(n,p,{embedded:!0,root:a,onClose:function(){c(l)}}),h=Lt(),v=G+2*J>=h,y=v?J/2:J,w=v?h-2*y:G,x=Mt()-2*y,E=i.mode===b;p.src=e,p.frameBorder="no",p.width=w+"",p.height="10",p.scrolling="no",d(p,{transform:"translate(0) scale(1,1)"}),d(a,{width:p.width+"px",height:"10px",position:"fixed",opacity:"0",borderRadius:"4px",transform:"translate(0, 20px)",boxShadow:"rgba(0,0,0,.16) 0 4px 20px",zIndex:S,overflow:"hidden",background:"#fff"}),E?(d(a,{top:"50%",left:"50%"}),d(l,{left:"0",top:"0",right:"0",bottom:"0",position:"fixed",zIndex:L,background:"rgba(0,0,0,.5)",display:"flex",alignItems:"center",justifyContent:"center"}),l.innerHTML='<div style="width: 64px; height: 64px">'+f("#fff")+"</div>"):d(a,{top:y+"px",right:y+"px"});u(a,p),u(Z.body,l),u(Z.body,a),r(o+"try_open"),g.on("connect",function(){r(o+"connected"),ot.send("connected",{})});var O=function(t){var n,e=[],o=!1;function i(t){t(n)}return t(function(t){o||(n=t,o=!0,e.forEach(i),e.length=0)}),{then:function(t){o?i(t):e.push(t)}}}(function(t){g.on("repaint",function(n){var e=n.rect,o=ot.el,i=o.parentElement,r=Math.min(e.height,x);e.height>100&&(o.height=r+"",o.width=w+"",o.scrolling=e.height>x?"yes":"no",d(i,{width:w+"px",height:o.height+"px"}),E&&d(i,{marginTop:"-"+r/2+"px",marginLeft:"-"+w/2+"px"}),t())})});return g.on("ready",function(t){var n=t.hidden;r(o+"ready"),r(o+"ready_hidden_"+n),n||O.then(function(){var t=E?".6s ease-out":".25s";p.getBoundingClientRect(),l.textContent="",d(a,{opacity:"1",transform:"translate(0, 0)",transition:"transform "+t+", opacity "+t}),wt(i),setTimeout(function(){d(a,{transition:"height .15s ease-out"})},1e3)})}),g.on("open:login",function(t){var n=t.email;r(o+"open_login"),g.close(),et=!1,mt(null,{email:n,embedded:!1})}),g.on("unavailable",function(t){var n=t.mode;r(o+"unavailable_"+n),n===_&&(et=!1,tt=!0,K.mode=m,K.autoLogin=!1),bt(K.onunavailable,{mode:i.mode}),g.close()}),g}(p)}return it?(It("using proxy port",n),r(i+"_create_proxy_port"),wt(t),Et(n,{postMessage:function(t){it.send("login:proxy",t)}},{embedded:e})):(It("create popup portal",n),r(i+"_create_popup"),wt(t),rt=function t(n){try{return V.open(o,n,Nt())}catch(e){return"_blank"!==n?t("_blank"):null}}(j),at=V.setInterval(function(){try{if(!rt.top||rt.closed)throw"Y"}catch(t){St(n,"login:closed",{}),V.clearInterval(at)}},100),Et(n,rt,{embedded:!1}))}(n),et=!0,ot.embedded?(ot.on("cancel",function(){It("embedded portal[login] canceled"),l(W,!0,K.ttlCloseState),r("popup_embedded_"+n.mode+"_canceled"),e(!1),xt(n)}),H.push(function(){It("embedded portal[login] resolved"),e(!0)})):(it||ot).on("login:closed",function(){It("portal[login] closed"),r("popup_"+n.mode+"_closed_proxy"),e(!0),xt(n)})}}function _t(t){st?t(st):(z.push(t),1===z.length&&o(pt("userinfo",{access_token:ut}),function(t,n){var e;(e=n)&&e.hasOwnProperty("error")||(st=n,lt=g),bt(z,st),z.length=0}))}function vt(t){return{status:lt,user:t?null:st,access_token:t?null:ut}}function bt(t,n){if(t instanceof Array)t.forEach(function(t){bt(t,n)});else try{t&&t.call(null,n)}catch(t){kt(t.stack)}}function yt(t,n,e){return pt("login",{scope:K.scopes.join(" "),response_type:"token",embedded:t?"Y":null,mode:e.mode,state:JSON.stringify({cid:n,loginState:l(X),ttlLoginState:K.ttlLoginState}),login:e.email})}function wt(t){bt(K.onshow,{mode:t.mode})}function xt(t){bt(K.onclose,{mode:t.mode})}function Et(t,n,e){var o=e.root||n,i={el:n,embedded:e.embedded,root:o,send:function(e,o){var i=JSON.stringify({cid:t,type:e,detail:o});It("[port] send: "+e+", detail:",o);try{n.contentWindow.postMessage(i,I)}catch(t){try{n.postMessage(i,I)}catch(t){}}},on:function(n,e,o){return e&&ft(t,n,e,o),this},close:function(){this.send("login:close",{}),c(o),function(t){var n=new RegExp("^"+dt(t,""));for(var e in D)n.test(e)&&delete D[e]}(t),e.onClose&&e.onClose(),o=n=null}};return It("[port] created: "+t+", iframe: "+(n instanceof HTMLIFrameElement)),i}function Ot(t){if(t[M]!==M){t[M]=M,d(t,{position:"relative"});var n=function(t,n){var e=t.attributes.length;for(;e--;){var o=t.attributes[e],i=o.name,r=o.value,a=U.test(i)?i.substr(5):null;a&&(C.test(a)?(!V[r]&&kt("Callback '"+i+'="'+r+"\"' not found"),n[a]=V[r]):T[a]&&(n[a]=r))}return n}(t,{cid:Y++,type:k,ui:""}),e=s("iframe"),o=Et(n.cid,e,{embedded:!1});e.width="100%",e.height="100%",d(e,{display:"inline-block",verticalAlign:"middle",borderRadius:"2px",transition:"all .1s ease-out"});var i=function(){return o.send("login:cfg",{url:yt(!1,n.cid,{mode:m,modern:!0}),name:j,embedded:K.mode===b,width:B,height:F,params:Nt()})};t.addEventListener("focusin",function(){i()}),t.addEventListener("mouseover",function(){i()}),t.addEventListener("touchstart",function(){i()}),o.on("load",function(t){It("port[button] loaded",n.cid),i(),ct.push(o),n.ui.indexOf(E)>-1&&o.on("resize",function(t){var n=t.width,o=t.height;e.width=n,e.height=o}),o.on("beforeclick",function(t){ct.forEach(function(t){t!==o&&t.send("login:close",{})}),bt(n.onbeforeclick,t)}),o.on("open:embedded",function(){It("port[button] invoke embedded login",n.cid),mt(null,{mode:b})}),o.on("click",function(t){st?(r("button_logout_click"),gt(n.onlogout)):(r("button_login_click"),it=o,mt(n.onlogin)),bt(n.onclick,t)}),r("button_onload_"+t.status),bt(n.onload,t)},!0),e.onerror=function(){kt("[transport] Internal error"),r("transport_error"),bt(n.onerror,vt(!0))},e.setAttribute("frameborder","0"),e.scrolling="no",u(t,e),e.src=pt("btn",n),It("port[button] created",n)}}function kt(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];Q.push("warn",t)}function It(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];Q.push("info",t)}function St(t,n,e){var o=dt(t,n);D.hasOwnProperty(o)&&bt(D[o],e)}function Lt(){return V.innerWidth||Z.documentElement.clientWidth}function Mt(){return V.innerHeight||Z.documentElement.clientHeight}function Nt(){var t=V.screen,n=null!=V.screenLeft?V.screenLeft:t.left,e=null!=V.screenTop?V.screenTop:t.top,o=Lt()||t.width,i=Mt()||t.height;return["scrollbars=no","left="+((o-B)/2+(parseInt(n,10)||0)),"top="+((i-F)/2.3+(parseInt(e,10)||0)),"width="+B,"height="+F].join(",")}function Tt(t){var n=t.origin,e=t.data;if(""!==e&&n===I)try{It("message",e);var o=JSON.parse(e),i=o.cid,a=o.type,s=o.detail;switch(St(i,a,s),a){case"load":lt=s.status,r("message_load_auth_status_"+s.status);break;case"auth":r("message_auth_status_"+s.status),ut=s.access_token||null,H.splice(0,1e6).forEach(function(t){t({status:ut?g:h,access_token:ut})}),ut&&K.ttlLoginState&&l(X,!0,K.ttlLoginState)}}catch(t){kt(t.stack||t.message)}}setInterval(function(){ct=ct.filter(function(t){if("IFRAME"===t.el.nodeName){for(var n=t.el;n=n.parentNode;)if(n===Z.body)return!0;return It("[gc] port removed:",t),!1}return!0})},3e4),t.AUTH_UNKNOWN=p,t.AUTH_CONNECTED=g,t.AUTH_NOT_AUTHORIZED=h,t.MODE_DEFAULT=m,t.MODE_ONETAP=_,t.MODE_HIDDEN=v,t.MODE_EMBEDDED=b,t.LANG_RU=y,t.LANG_EN="en-US",t.SCOPE_USER_INFO=w,t.SCOPE_MAIL_PHONE=x,t.SCOPE_MAIL_IMAP="mail.imap",t.SCOPE_CLOUD_API="cloud.api",t.UI_FULL_FIT=E,t.UI_LOGIN_AS="login_as",t.UI_USERPIC="userpic",t.UI_ALWAYS_LOGIN="always_login",t.BUTTON_CLASSNAME=O,t.BUTTON_TYPE_LOGIN=k,t.OAUTH_HOST=I,t.__DEV__=function(t){},t.reset=function(){l(W,null),l(X,null)},t.init=function(t){if(q)It("reinit",t);else{if(It("init",t),!t)throw new Error("[MR.init] `options` not defined");if(q=!0,K=t,!t.clientId)throw new Error("[MR.init] `options.clientId` not defined");null==t.lang&&(t.lang=(V.location.toString().match(P)||[])[1]||V.navigator.language||V.navigator.languages&&V.navigator.languages[0]||y),It("[button] lang: "+t.lang+" (nav: "+V.navigator.language+", ["+V.navigator.languages+"]"),null==t.scopes&&(t.scopes=[w]),null==t.modern&&(t.modern=t.scopes.indexOf(x)>-1||location.toString().indexOf("o2.modern")>-1),null==t.mode&&(t.mode=m),null==t.ttlCloseState&&(t.ttlCloseState=2592e3),null==t.ttlLoginState&&(t.ttlLoginState=t.mode===_?604800:0),t.mode===_&&(l(W)||(It("onetap autologin"),mt(null,{mode:_}))),V.addEventListener("message",Tt,!1)}!function(t){for(var n=Z.getElementsByClassName(O),e=n.length;e--;)t(n[e])}(Ot)},t.logout=gt,t.auth=function(t){var n=Y++,e=s("iframe");It("call auth"),d(e,{visibility:"hidden",position:"absolute",left:"-999px",top:"-999px"}),e.src=pt("login",{scope:K.scopes.join(" "),response_type:"token",mode:v,state:"cid="+n+"&e="+M}),b===K.mode?H.push(function(n){var o=-1!==K.scopes.indexOf(w);c(e),n.status===g?o?_t(function(){It("auth successfully with userinfo",vt()),bt(t,vt()),ht()}):(It("auth successfully",n),bt(t,n),ht()):(kt("User not authorized:",n),mt(t,{userinfo:o,mode:b}))}):H.push(t),u(Z.body,e)},t.login=mt,t.getUser=_t,t.getState=function(){return vt()},t.getRuntimeLog=function(){return Q},Object.defineProperty(t,"__esModule",{value:!0})});
